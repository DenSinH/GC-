#include "PPC/instructions.h"

const u32 mtfsf_bit_mask[0x100] = {
        0x00000000,0x0000000f,0x000000f0,0x000000ff,0x00000f00,0x00000f0f,0x00000ff0,0x00000fff,
        0x0000f000,0x0000f00f,0x0000f0f0,0x0000f0ff,0x0000ff00,0x0000ff0f,0x0000fff0,0x0000ffff,
        0x000f0000,0x000f000f,0x000f00f0,0x000f00ff,0x000f0f00,0x000f0f0f,0x000f0ff0,0x000f0fff,
        0x000ff000,0x000ff00f,0x000ff0f0,0x000ff0ff,0x000fff00,0x000fff0f,0x000ffff0,0x000fffff,
        0x00f00000,0x00f0000f,0x00f000f0,0x00f000ff,0x00f00f00,0x00f00f0f,0x00f00ff0,0x00f00fff,
        0x00f0f000,0x00f0f00f,0x00f0f0f0,0x00f0f0ff,0x00f0ff00,0x00f0ff0f,0x00f0fff0,0x00f0ffff,
        0x00ff0000,0x00ff000f,0x00ff00f0,0x00ff00ff,0x00ff0f00,0x00ff0f0f,0x00ff0ff0,0x00ff0fff,
        0x00fff000,0x00fff00f,0x00fff0f0,0x00fff0ff,0x00ffff00,0x00ffff0f,0x00fffff0,0x00ffffff,
        0x0f000000,0x0f00000f,0x0f0000f0,0x0f0000ff,0x0f000f00,0x0f000f0f,0x0f000ff0,0x0f000fff,
        0x0f00f000,0x0f00f00f,0x0f00f0f0,0x0f00f0ff,0x0f00ff00,0x0f00ff0f,0x0f00fff0,0x0f00ffff,
        0x0f0f0000,0x0f0f000f,0x0f0f00f0,0x0f0f00ff,0x0f0f0f00,0x0f0f0f0f,0x0f0f0ff0,0x0f0f0fff,
        0x0f0ff000,0x0f0ff00f,0x0f0ff0f0,0x0f0ff0ff,0x0f0fff00,0x0f0fff0f,0x0f0ffff0,0x0f0fffff,
        0x0ff00000,0x0ff0000f,0x0ff000f0,0x0ff000ff,0x0ff00f00,0x0ff00f0f,0x0ff00ff0,0x0ff00fff,
        0x0ff0f000,0x0ff0f00f,0x0ff0f0f0,0x0ff0f0ff,0x0ff0ff00,0x0ff0ff0f,0x0ff0fff0,0x0ff0ffff,
        0x0fff0000,0x0fff000f,0x0fff00f0,0x0fff00ff,0x0fff0f00,0x0fff0f0f,0x0fff0ff0,0x0fff0fff,
        0x0ffff000,0x0ffff00f,0x0ffff0f0,0x0ffff0ff,0x0fffff00,0x0fffff0f,0x0ffffff0,0x0fffffff,
        0x90000000,0x9000000f,0x900000f0,0x900000ff,0x90000f00,0x90000f0f,0x90000ff0,0x90000fff,
        0x9000f000,0x9000f00f,0x9000f0f0,0x9000f0ff,0x9000ff00,0x9000ff0f,0x9000fff0,0x9000ffff,
        0x900f0000,0x900f000f,0x900f00f0,0x900f00ff,0x900f0f00,0x900f0f0f,0x900f0ff0,0x900f0fff,
        0x900ff000,0x900ff00f,0x900ff0f0,0x900ff0ff,0x900fff00,0x900fff0f,0x900ffff0,0x900fffff,
        0x90f00000,0x90f0000f,0x90f000f0,0x90f000ff,0x90f00f00,0x90f00f0f,0x90f00ff0,0x90f00fff,
        0x90f0f000,0x90f0f00f,0x90f0f0f0,0x90f0f0ff,0x90f0ff00,0x90f0ff0f,0x90f0fff0,0x90f0ffff,
        0x90ff0000,0x90ff000f,0x90ff00f0,0x90ff00ff,0x90ff0f00,0x90ff0f0f,0x90ff0ff0,0x90ff0fff,
        0x90fff000,0x90fff00f,0x90fff0f0,0x90fff0ff,0x90ffff00,0x90ffff0f,0x90fffff0,0x90ffffff,
        0x9f000000,0x9f00000f,0x9f0000f0,0x9f0000ff,0x9f000f00,0x9f000f0f,0x9f000ff0,0x9f000fff,
        0x9f00f000,0x9f00f00f,0x9f00f0f0,0x9f00f0ff,0x9f00ff00,0x9f00ff0f,0x9f00fff0,0x9f00ffff,
        0x9f0f0000,0x9f0f000f,0x9f0f00f0,0x9f0f00ff,0x9f0f0f00,0x9f0f0f0f,0x9f0f0ff0,0x9f0f0fff,
        0x9f0ff000,0x9f0ff00f,0x9f0ff0f0,0x9f0ff0ff,0x9f0fff00,0x9f0fff0f,0x9f0ffff0,0x9f0fffff,
        0x9ff00000,0x9ff0000f,0x9ff000f0,0x9ff000ff,0x9ff00f00,0x9ff00f0f,0x9ff00ff0,0x9ff00fff,
        0x9ff0f000,0x9ff0f00f,0x9ff0f0f0,0x9ff0f0ff,0x9ff0ff00,0x9ff0ff0f,0x9ff0fff0,0x9ff0ffff,
        0x9fff0000,0x9fff000f,0x9fff00f0,0x9fff00ff,0x9fff0f00,0x9fff0f0f,0x9fff0ff0,0x9fff0fff,
        0x9ffff000,0x9ffff00f,0x9ffff0f0,0x9ffff0ff,0x9fffff00,0x9fffff0f,0x9ffffff0,0x9fffffff,
};

INLINE_GEKKO_INSTR(mtfsf) {
    GEKKO_INSTR_HEADER
    log_cpu("mtfsf %x", instruction.raw);

    cpu->FPSCR.raw = GET_FPR(cpu, instruction.mtfsf.B) & mtfsf_bit_mask[instruction.mtfsf.FM];
    // todo: GET_FPR? also, floating point exceptions?
    if (instruction.mtfsf.Rc) {
        UPDATE_CR_FROM_FPSCR(cpu->CR, cpu->FPSCR);
    }
}

INLINE_GEKKO_INSTR(mtfsb0) {
    GEKKO_INSTR_HEADER
    log_cpu("mtfsb0 %08x", instruction.raw);

    cpu->FPSCR.raw &= ~(1 << instruction.general_DAB.D);
    if (instruction.general_DAB.Rc) {
        UPDATE_CR_FROM_FPSCR(cpu->CR, cpu->FPSCR);
    }
}

INLINE_GEKKO_INSTR(mtfsb1) {
    GEKKO_INSTR_HEADER
    log_cpu("mtfsb0 %08x", instruction.raw);

    cpu->FPSCR.raw |= 1 << instruction.general_DAB.D;
    if (instruction.general_DAB.Rc) {
        UPDATE_CR_FROM_FPSCR(cpu->CR, cpu->FPSCR);
    }
}